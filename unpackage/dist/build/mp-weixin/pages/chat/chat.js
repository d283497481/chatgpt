(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"123b":function(t,s,e){"use strict";e.r(s);var i=e("f8db"),n=e("6262");for(var o in n)["default"].indexOf(o)<0&&function(t){e.d(s,t,(function(){return n[t]}))}(o);e("167f"),e("7071");var a=e("f0c5"),r=Object(a["a"])(n["default"],i["b"],i["c"],!1,null,"59b09424",null,!1,i["a"],void 0);s["default"]=r.exports},"167f":function(t,s,e){"use strict";var i=e("de35"),n=e.n(i);n.a},"50c0":function(t,s,e){},6262:function(t,s,e){"use strict";e.r(s);var i=e("a7df"),n=e.n(i);for(var o in i)["default"].indexOf(o)<0&&function(t){e.d(s,t,(function(){return i[t]}))}(o);s["default"]=n.a},7071:function(t,s,e){"use strict";var i=e("50c0"),n=e.n(i);n.a},a7df:function(t,s,e){"use strict";(function(t){var i=e("4ea4");Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=i(e("448a")),o=i(e("9523")),a=(e("26cb"),{data:function(){var s;return s={systemInfo:t.getSystemInfoSync(),baseUrl:getApp().globalData.server,toUid:0,sessionId:"",footAnimationData:{},scrollAnimationData:{},title:"",chatSrcollBottom:0,KeyboardHeight:0,safeBottom:0,adjustPosition:!0,msgList:[],msg:"",scrollTop:0,srcollHeight:0,chatDetailHeight:0,willStop:!1,initPoint:{identifier:0,Y:0},chatDetailBoxMaxWidth:0,focus:!1,refreshing:!1,ready:!1,isWxapp:!1,isLogin:!1,loading:!1,loginType:"",navTip:"",source:null,parentId:1,token:"",isDone:!0,isFirst:!0},(0,o.default)(s,"scrollTop",0),(0,o.default)(s,"fromId",""),(0,o.default)(s,"toId",""),(0,o.default)(s,"fromMsg",""),(0,o.default)(s,"toMsg",""),(0,o.default)(s,"msgAll",[]),(0,o.default)(s,"ids",[]),(0,o.default)(s,"rememberContext",!1),(0,o.default)(s,"allAI",!1),(0,o.default)(s,"placeholder",""),(0,o.default)(s,"isStartAllAI",!1),(0,o.default)(s,"sessionId2","-1"),(0,o.default)(s,"role","assistant"),(0,o.default)(s,"parentId2",1),(0,o.default)(s,"isDebug",!1),(0,o.default)(s,"imgGen",!1),(0,o.default)(s,"isSync",!1),(0,o.default)(s,"status",!0),s},destroyed:function(){},onLoad:function(s){this.safeBottom=this.systemInfo.safeAreaInsets.bottom>0?this.systemInfo.safeAreaInsets.bottom:0,this.sessionId=s.id,this.title=s.name,this.navTip=s.name,this.chatDetailBoxMaxWidth=this.systemInfo.screenWidth-110,this.isLogin=t.getStorageSync("is_login"),this.loginType=t.getStorageSync("login_type"),this.status=t.getStorageSync("status")},onShow:function(){this.isWxapp=!0,this.onKeyboardHeight(),this.safeBottom=this.systemInfo.safeAreaInsets.bottom>0?this.systemInfo.safeAreaInsets.bottom:0,this.srcollHeight=this.systemInfo.screenHeight-this.systemInfo.statusBarHeight-25-this.safeBottom-55,this.srcollHeight=this.systemInfo.screenHeight-this.systemInfo.statusBarHeight-10-this.safeBottom-55;this.isLogin=t.getStorageSync("is_login"),this.loginType=t.getStorageSync("login_type"),this.token=t.getStorageSync("token"),this.rememberContext=t.getStorageSync("remember_context");var s=t.getStorageSync("all_ai");!0===s&&(this.allAI=!0,this.placeholder="请输入起始语句"),t.$on("onMessage",this.onMessage),this.isDebug=t.getStorageSync("isDebug");var e=t.getStorageSync("ai_gen_img");!0===e&&(this.imgGen=!0,this.placeholder="请输入图片描述"),this.isSync=t.getStorageSync("sync_session"),this.status=t.getStorageSync("status"),this.getChatList()},onReady:function(){this.scrollToBottom(),this.ready=!0},onShareAppMessage:function(t){return{title:getApp().globalData.name,path:"/pages/chat/session",imageUrl:"/static/image/share_screen_slot.png"}},onShareTimeline:function(t){return{title:getApp().globalData.name}},onPullDownRefresh:function(){},computed:{chatBodyBottom:function(){return"height:".concat(this.srcollHeight,"px;")}},onHide:function(){},methods:{onMessage:function(t){if(t.conversationId===this.sessionId){this.isDone=t.isDone,this.allAI&&this.isStartAllAI&&(t.isSend="user"===this.role);var s=this;if(!t.isDone)if(t.isSuccess&&t.id)if(-1===this.ids.indexOf(t.id))this.msgList.push(t),this.ids.push(t.id),this.navTip="正在打字中...",this.toId=t.id,this.allAI&&this.isStartAllAI&&"user"===this.role?this.parentId2=t.id:this.parentId=t.id;else for(var e=this.msgList.length-1;e>=0;e--){var i=this.msgList[e];if(i.id===t.id){i.content=t.content,i.html=t.html,this.toMsg=i.content;break}}else if(!t.isSuccess&&(this.msgList.push(t),this.allAI&&this.isStartAllAI))return this.isStartAllAI=!1,this.placeholder="请输入起始语句",this.msg="",this.showToast("已停止!","success");if(t.isDone&&(this.navTip=this.title,t.isSuccess&&this.toId&&("pwd"!==this.loginType&&"token"!==this.loginType||(this.sessionId&&"-1"!=this.sessionId?this.allAI&&"-1"==this.sessionId2&&"user"===this.role&&this.getSessionListRes(!1):this.getSessionListRes(!0)),this.allAI&&this.isStartAllAI&&setTimeout((function(){s.sendMsg4Ai(s.toMsg)}),3500)),!t.isSuccess&&(this.msgList.push(t),this.allAI&&this.isStartAllAI)))return this.isStartAllAI=!1,this.placeholder="请输入起始语句",this.msg="",this.showToast("已停止!","success");this.scrollToBottom(),this.update2Store()}},onKeyboardHeight:function(){var s=this;t.onKeyboardHeightChange((function(t){s.translatePageTop(t.height),"android"==s.systemInfo.platform?t.height>100?(s.chatSrcollBottom=t.height-s.safeBottom,s.KeyboardHeight=2*s.safeBottom+70,s.srcollHeight=s.systemInfo.screenHeight-s.systemInfo.statusBarHeight-10-s.safeBottom-100):(s.chatSrcollBottom=0,s.KeyboardHeight=2*s.safeBottom,s.srcollHeight=s.systemInfo.screenHeight-s.systemInfo.statusBarHeight-10-s.safeBottom-55):t.height>300?s.chatSrcollBottom=t.height-s.safeBottom:s.chatSrcollBottom=0,0===t.height&&(s.focus=!1),s.scrollToBottom()}))},onpullingdown:function(t){},translatePageTop:function(s){var e=t.createAnimation({duration:220,timingFunction:"ease"}),i=t.createAnimation({duration:220,timingFunction:"ease"});0==s?(e.translateY(-s).step(),i.translateY(-s).step()):(e.translateY(34-s).step(),i.translateY(34-s).step()),this.scrollAnimationData=e.export(),this.footAnimationData=i.export()},inputScroll:function(){var t=this.getEl(this.$refs.foot);if(this.chatSrcollBottom)var s=-10;else s=0;var e=BindingX.bind({eventType:"timing",exitExpression:"t>1",props:[{element:t,property:"transform.translateY",expression:"easeInOutSine(t,0,"+s+",1)"}]},(function(t){"exit"===t.state&&BindingX.unbind({token:e})}))},scrollToBottom:function(){var s=this;this.$nextTick((function(){t.createSelectorQuery().in(s).select(".scroll-view-content").boundingClientRect((function(t){var e=t.height-s.srcollHeight;e>0&&(s.scrollTop=e)})).exec()}))},hideKey:function(){t.hideKeyboard(),this.inputFocus()},getEl:function(t){return"string"===typeof t||"number"===typeof t?t:WXEnvironment?t.ref:t instanceof HTMLElement?t:t.$el},inputFocus:function(){if(this.showMore){t.upx2px(180);var s=t.createAnimation({duration:220,timingFunction:"ease"});s.translateX(0).step(),this.showMore=!1}},sendMsg:function(){if(this.status){if(!this.msg||""===this.msg.trim())return this.showToast("请输入内容~","error");if(this.allAI&&this.isStartAllAI)return"停止"===this.msg?(this.isStartAllAI=!1,this.placeholder="请输入起始语句",this.msg="",this.showToast("停止成功!","success")):this.showToast("无效输入~","error");if(!this.isDone)return this.showToast("还在回答问题呢,不要着急哦~","error");var s={content:this.msg,html:this.msg,isSend:!0,isSuccess:!0,createTime:(new Date).getTime(),id:this.$store.state.utils.uuid(),role:"user"};this.fromId=s.id;var e={authValue:"Bearer "+this.token,content:s.content,parentId:this.parentId,id:s.id};if(this.isLogin||(e.isDemo=!0),"-1"!=this.sessionId&&(e.conversationId=this.sessionId),"api"===this.loginType){e.authType="api";var i={role:"user",content:this.msg},n=[];n.push(i),e.messages=n}if(""!=this.msg){if(this.msgList.push(s),this.allAI&&(this.isStartAllAI=!0),"api"===this.loginType||!this.isLogin){if(this.rememberContext){e.messages=[];var o=this.msgList.length-4;o<0&&(o=0);for(var a=o;a<this.msgList.length;a++){var r=this.msgList[a];r.isSuccess&&!r.isImg&&e.messages.push(r)}}else{var h={role:"user",content:this.msg},l=[];l.push(h),e.messages=l}this.imgGen&&(e.isGenImg=!0)}if((this.isDebug||!this.isLogin||!this.isSync||"api"===this.loginType)&&"-1"==this.sessionId){this.sessionId=this.$store.state.utils.uuid();var u=t.getStorageSync("sessionList");u&&0!==u.length||(u=[]);var c={createTime:(new Date).getTime(),id:this.sessionId,title:"会话"+(u.length+1)};this.isDebug||this.isSync||"pwd"!==this.loginType&&"token"!==this.loginType||(this.sessionId="-1",c.id="-1"),u.push(c),t.setStorageSync("sessionList",u)}e.conversationId=this.sessionId,this.navTip="正在思考中...",this.isDone=!1;var d=this;this.update2Store(),this.msg="",getApp().globalData.$socket.sendMessage(JSON.stringify(e),(function(t,s){t||(d.navTip=d.title,d.isDone=!0,d.isStartAllAI=!1)})),this.fromMsg=this.msg}this.scrollToBottom(),this.allAI&&this.isStartAllAI&&(this.placeholder="输入'停止'终止会话")}else this.showNotify("服务器正在维护中~","error")},sendMsg4Ai:function(t){var s=this;if(t&&""!==t.trim()){var e={content:t,html:t,isSend:"user"===this.role,createTime:(new Date).getTime(),id:this.$store.state.utils.uuid(),role:this.role},i={authValue:"Bearer "+this.token,content:e.content,parentId:this.parentId,id:e.id};if(this.isLogin||(i.isDemo=!0),"user"===this.role&&(i.conversationId=this.sessionId,i.parentId=this.parentId),"assistant"===this.role&&(i.conversationId=this.sessionId2,i.parentId=this.parentId2),"api"===this.loginType&&(i.authType="api"),""!=t){if("api"===this.loginType)if(this.rememberContext){i.messages=[];var n=this.msgList.length-4;n<0&&(n=0);for(var o=n;o<this.msgList.length;o++){var a=this.msgList[o];a.isSuccess&&!a.isImg&&i.messages.push(a)}}else{var r={role:"user",content:t},h=[];h.push(r),i.messages=h}this.navTip="正在思考中...",this.isDone=!1;var l=this;i.conversationId=this.sessionId,getApp().globalData.$socket.sendMessage(JSON.stringify(i),(function(t,e){t||(l.navTip=l.title,s.isDone=!0,l.isStartAllAI=!1)})),"user"===this.role?this.role="assistant":"assistant"===this.role&&(this.role="user")}this.scrollToBottom()}},getChatList:function(){if(!this.sessionId||"-1"==this.sessionId)return this.parentId=1,void(this.msgList=[]);if("99999999"==this.sessionId){var s={content:"你好",html:"你好",isSend:!0,createTime:(new Date).getTime(),id:this.$store.state.utils.uuid(),role:"user"};this.msgList.push(s),s={content:'您好，这是一条demo消息! 您每天有20次向我提问的机会(基于IP), 登录用户不受此限制。发送 "查询次数" 查询剩余次数, 且用且珍惜!',html:'您好，这是一条demo消息! 您每天有20次向我提问的机会(基于IP), 登录用户不受此限制。发送 "查询次数" 查询剩余次数, 且用且珍惜!',isSend:!1,createTime:(new Date).getTime(),id:this.$store.state.utils.uuid(),role:"assistant"},this.msgList.push(s),s={content:"关于请求速率: 为了防止有人恶意请求，服务器增加了会话速率限制20 请求/分钟/IP",html:"关于请求速率: 为了防止有人恶意请求，服务器增加了会话速率限制20 请求/分钟/IP",isSend:!1,createTime:(new Date).getTime(),id:this.$store.state.utils.uuid(),role:"assistant"},this.msgList.push(s)}var e,i=[],o=t.getStorageSync("chatList");o&&(i=o[this.sessionId],i&&(e=this.msgList).push.apply(e,(0,n.default)(i)));i&&i.length>0&&(this.parentId=this.msgList[this.msgList.length-1].id),this.isDebug||!this.isSync||i&&0!==i.length||"pwd"!==this.loginType&&"token"!==this.loginType||this.getChatListRes()},getChatListRes:function(){if(!this.sessionId||"-1"==this.sessionId)return this.navTip=" 新会话",!1;var s=this;this.loading=!0,this.navTip="加载中",t.showLoading({title:"正在同步消息..."});var e={},i=t.getStorageSync("token");i&&(e={Authorization:"Bearer "+i}),console.log(">>request messageList..."),t.request({url:s.baseUrl+"/backend-api/conversation?id="+s.sessionId,data:{},header:e,success:function(e){if(t.stopPullDownRefresh(),s.loading=!1,t.hideLoading(),"000000"!==e.data.status)return s.navTip="服务出错",s.showNotify("服务出错!","error");e.data.messageList&&(s.navTip=s.title,s.msgList=e.data.messageList,s.update2Store(),s.parentId=s.msgList[s.msgList.length-1].id)},fail:function(e){return t.stopPullDownRefresh(),s.navTip="服务出错",t.hideLoading(),s.showNotify("服务出错!","error")}})},update2Store:function(){var s=t.getStorageSync("chatList");s||(s={}),s[this.sessionId]=this.msgList,t.setStorageSync("chatList",s)},moderations:function(s,e){var i={conversationId:this.sessionId,content:e,id:s},n={},o=t.getStorageSync("token");o&&(n={Authorization:"Bearer "+o});t.request({url:this.baseUrl+"/backend-api/moderation",method:"POST",data:i,header:n,success:function(t){"000000"!==t.data.status&&console.log(t.data)},fail:function(t){console.log(t.data)}})},getSessionListRes:function(s){if(!(this.isDebug||"pwd"!==this.loginType&&"token"!==this.loginType)){var e=this,i={},n=t.getStorageSync("token");n&&(i={Authorization:"Bearer "+n}),console.log(">>request sessionList..."),t.request({url:e.baseUrl+"/backend-api/conversations",data:{},header:i,success:function(i){if("000000"===i.data.status){if(i.data.list)if(!s||e.sessionId&&"-1"!=e.sessionId)s||"-1"!=e.sessionId2||(e.sessionId2=i.data.list[0].id);else{if(e.sessionId=i.data.list[0].id,e.isSync)t.setStorageSync("sessionList",i.data.list);else{var n=t.getStorageSync("sessionList");n&&(n[n.length-1].id=e.sessionId,t.setStorageSync("sessionList",n))}e.genTitle(),e.update2Store()}}else console.log(i)},fail:function(t){console.log(t)}})}},genTitle:function(){var s=this,e={conversationId:this.sessionId,id:this.toId},i={},n=t.getStorageSync("token");n&&(i={Authorization:"Bearer "+n}),t.request({url:s.baseUrl+"/backend-api/gentitle",method:"POST",data:e,header:i,success:function(e){if("000000"===e.data.status){if(e.data.title){s.navTip=e.data.title,s.title=e.data.title;var i=t.getStorageSync("sessionList");i&&(s.isSync?(i[0].title=e.data.title,t.setStorageSync("sessionList",i)):i[i.length-1]=s.sessionId)}}else console.log(e.data)},fail:function(t){console.log(t.data)}})},showNotify:function(t,s){this.$refs.uNotify.show({type:s,message:t,duration:3e3,safeAreaInsetTop:!0})},showToast:function(t,s){this.$refs.uToast.show({message:t,type:s,duration:2e3,position:"bottom"})}}});s.default=a}).call(this,e("543d")["default"])},c170:function(t,s,e){"use strict";(function(t,s){var i=e("4ea4");e("cd32"),e("a9ff");i(e("66fd"));var n=i(e("123b"));t.__webpack_require_UNI_MP_PLUGIN__=e,s(n.default)}).call(this,e("bc2e")["default"],e("543d")["createPage"])},de35:function(t,s,e){},f8db:function(t,s,e){"use strict";e.d(s,"b",(function(){return n})),e.d(s,"c",(function(){return o})),e.d(s,"a",(function(){return i}));var i={uniNavBar:function(){return e.e("uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar").then(e.bind(null,"38f7"))},uniChatDetail:function(){return Promise.all([e.e("common/vendor"),e.e("components/uni-chat-detail/uni-chat-detail")]).then(e.bind(null,"4985"))},uNotify:function(){return Promise.all([e.e("common/vendor"),e.e("uni_modules/uview-ui/components/u-notify/u-notify")]).then(e.bind(null,"52a0"))},uToast:function(){return e.e("uni_modules/uview-ui/components/u-toast/u-toast").then(e.bind(null,"193b"))}},n=function(){var t=this,s=t.$createElement,e=(t._self._c,t.__map(t.msgList,(function(s,e){var i=t.__get_orig(s),n=s.content.trim();return{$orig:i,g0:n}})));t._isMounted||(t.e0=function(s){return t.$store.state.utils.back()}),t.$mp.data=Object.assign({},{$root:{l0:e}})},o=[]}},[["c170","common/runtime","common/vendor"]]]);